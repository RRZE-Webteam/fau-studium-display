const{__,_x,_n,sprintf}=wp.i18n;jQuery(document).ready(function($){let searchResults=$("#degree-program-results");let programsImported=$("#degree-programs-imported");$("#degree-search-button").on("click",function(e){e.preventDefault();let $this=$(this);$this.append('<span class="dashicons dashicons-update search-spinner spin" title="Searching">Searching</span>').addClass("button-disabled");searchResults.empty();let selectedFaculties=$('input[name="faculty[]"]:checked').map(function(){return $(this).val()}).get();let selectedDegrees=$('input[name="degree[]"]:checked').map(function(){return $(this).val()}).get();$.ajax({url:program_ajax.ajax_url,type:"POST",data:{action:"program_search",_ajax_nonce:program_ajax.nonce,faculties:selectedFaculties,degrees:selectedDegrees},success:function(response){if(response.success){$("div#degree-program-results").html(response.data.message)}else{$this.removeClass("button-disabled")}$this.removeClass("button-disabled");$("span.search-spinner").remove()},error:function(response){$this.removeClass("button-disabled");$("span.search-spinner").remove()}})});searchResults.on("click","button#import-select-all-button",function(e){e.preventDefault();const checkboxes=$('input[type="checkbox"][name^="batch-import"]');const allChecked=checkboxes.length===checkboxes.filter(":checked").length;checkboxes.prop("checked",!allChecked)});searchResults.on("click","button#import-selected-button",function(e){e.preventDefault();const checkedIds=$('input[type="checkbox"][name^="batch-import"]:checked').map(function(){return $(this).data("id")}).get();if(checkedIds.length>0){searchResults.find("button, a.button").addClass("button-disabled");searchResults.find('input[type="checkbox"][name^="batch-import"]').addClass("disabled");$.each(checkedIds,function(index,id){$("#degree-program-results div.add-program-"+id+" a.add-degree-program").find("span.dashicons-plus").removeClass("dashicons-plus").addClass("dashicons-update").addClass("spin")});sync_degree_programs(checkedIds,[])}else{alert(__("No program selected. Please select at least one program to import.","fau-studium-display"))}});searchResults.on("click","a.add-degree-program",function(e){e.preventDefault();sync_degree_program($(this))});programsImported.on("click","button#manage-select-all-button",function(e){e.preventDefault();const checkboxes=$('input[type="checkbox"][name^="batch-manage"]');const allChecked=checkboxes.length===checkboxes.filter(":checked").length;checkboxes.prop("checked",!allChecked)});programsImported.on("click","button#update-selected-button",function(e){e.preventDefault();const checkedIds=$('input[type="checkbox"][name^="batch-manage"]:checked').map(function(){return $(this).val()}).get();if(checkedIds.length>0){sync_degree_programs([],checkedIds)}else{alert(__("No program selected. Please select at least one program.","fau-studium-display"))}});programsImported.on("click","button#delete-selected-button",function(e){e.preventDefault();const checkedIds=$('input[type="checkbox"][name^="batch-manage"]:checked').map(function(){return $(this).val()}).get();if(checkedIds.length<1){alert(__("No program selected. Please select at least one program.","fau-studium-display"))}else{if(confirm(sprintf(__("Are you sure you want to delete %d selected degree programs?","fau-studium-display"),checkedIds.length))){delete_degree_programs(checkedIds)}}});programsImported.on("click","a.update-degree-program",function(e){e.preventDefault();sync_degree_program($(this))});programsImported.on("click","a.delete-degree-program",function(e){e.preventDefault();let $this=$(this);$this.addClass("button-disabled");$this.parent().find("span.dashicons.dashicons-yes.sync-ok").remove();$this.parent().find("a.update-degree-program").addClass("button-disabled");$this.find("span.dashicons-trash").removeClass("dashicons-trash").addClass("dashicons-update").addClass("spin");$.ajax({url:program_ajax.ajax_url,type:"POST",data:{action:"program_delete",_ajax_nonce:program_ajax.nonce,post_ids:$this.data("post_id")},success:function(response){if(response.success){$this.find("span.dashicons-update").removeClass("spin");$this.append('<span class="dashicons dashicons-yes sync-ok" title="Deleted">Deleted</span>');$this.closest("div.program-item").remove()}else{console.log("Fehler: "+response.data)}},error:function(){console.log("AJAX-Fehler")}})});function sync_degree_program($button){let task=$button.data("task");$button.addClass("button-disabled");if(task==="add"){$button.find("span.dashicons-plus").removeClass("dashicons-plus").addClass("dashicons-update")}$button.find("span.dashicons-update").addClass("spin");$.ajax({url:program_ajax.ajax_url,type:"POST",data:{action:"program_sync",_ajax_nonce:program_ajax.nonce,program_id:$button.data("id"),post_id:$button.data("post_id")},success:function(response){$button.find("span.dashicons-update").removeClass("spin");if(task==="add"){$button.find("span.dashicons-update").removeClass("dashicons-update").addClass("dashicons-plus");$("#degree-program-results div.add-program-"+$button.data("id")+" input").remove()}if(response.success){$button.after('<span class="dashicons dashicons-yes sync-ok" title="Sync OK">Sync OK</span>');$button.remove()}else{$button.append('<span class="dashicons dashicons-no sync-error" title="Sync Error">Sync Error</span>');console.log("Fehler: "+response)}},error:function(){$button.find("span.dashicons-update").removeClass("spin");if(task==="add"){$button.find("span.dashicons-update").removeClass("dashicons-update").addClass("dashicons-plus")}console.log("AJAX-Fehler")}})}function sync_degree_programs(program_ids=[],post_ids=[]){$.ajax({url:program_ajax.ajax_url,type:"POST",data:{action:"program_sync",_ajax_nonce:program_ajax.nonce,program_ids:program_ids,post_ids:post_ids},success:function(response){console.log(response);if(response.success){const arr=JSON.parse(response.data);$.each(arr,function(index,id_synced){const searchResults=$("#degree-program-results");const parentDiv=searchResults.find("div.add-program-"+id_synced);const button=parentDiv.find("a.add-degree-program");button.after('<span class="dashicons dashicons-yes sync-ok" title="Sync OK">Sync OK</span>');button.remove();parentDiv.find("input").remove();searchResults.find('input[type="checkbox"][name^="batch-import"]').removeClass("disabled");searchResults.find("button, a.button").removeClass("button-disabled")})}else{console.log("Fehler: "+response)}},error:function(){console.log("Fehler: "+response)}})}function delete_degree_programs(ids){$.ajax({url:program_ajax.ajax_url,type:"POST",data:{action:"program_delete",_ajax_nonce:program_ajax.nonce,post_ids:ids},success:function(response){if(response.success){const arr=JSON.parse(response.data);$.each(arr,function(index,id_deleted){$("#degree-programs-imported div.program-item-"+id_deleted).remove()})}else{console.log("Fehler: "+response.data)}},error:function(){console.log("AJAX-Fehler")}})}});